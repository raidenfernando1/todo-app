---
import { Editor } from "../../app/editor/Editor";
import Layout from "../../layouts/Layout.astro";
import { db } from "../../lib/db";
import { auth } from "../../lib/auth";

type Note = {
  id: string;
  title: string;
  content: string;
};

const { id } = Astro.params;
const session = await auth.api.getSession({
  headers: Astro.request.headers,
});

if (!session) {
  throw new Error("Unauthorized");
}

const res = await db`
  SELECT * FROM get_todo_by_id(${id}::uuid, ${session.user.id}::text)
`;

const note = res[0] as Note;
---

<Layout>
  {note ? <Editor note={note} client:load /> : <p>Note not found</p>}
</Layout>
